# 实验报告

张海斌  
学号 17307130118

## 设计

大部份电路部件都与《数字设计和计算机体系结构》书中差不多，但是由于多了几条指令，一些地方需要作出一定的更改。

书中译码阶段使用了两个译码器先后进行译码操作，另一种方案是同时根据 Op 和 Funct 字段分别译码，获得 AluCtl，然后通过二选一多路选择器来根据指令是否为 R-Type 从二者中进行选择，获得正确的 AluCtl。在实验中，我先使用书中提供的译码方法，通过两个译码器先后译码，获得所需 AluCtl，之后又修改为 Op 和 Funct 同时译码，然后选择其中之一。原先书中使用了两位的 AluOp，标记第一次译码的结果，但是由于多添加了几条指令，两位已经不足以标记结果了，所以我将其扩充到三位，同时让它的结果直接与实际的 AluCtl 对应起来，除了 R-Type 使用 `2‘b011` 表示无操作，之后根据 AluOp 是否为 `2’b001` 来判断是否是 R-Type 指令从而决定是否需要进一步地译码。

针对 `andi` 和 `ori` 指令，需要使用无符号扩展，所以扩展有符号扩展和无符号扩展。我使用 `ExtOp` 控制符号和无符号扩展，1 为符号扩展。

对于 `beq` 和 `bne` 指令，我使用控制位 `Bne` 与 `Zero` 结果进行异或操作，再与 `Branch` 相与得到 `PCSrc`

为了实现暂停 CPU 并正常显示值的功能，我使用了两个 clkdiv 模块，分别为七段数码管和 CPU 提供时钟分频，其中 CPU 的时钟分频模块输入的 CLK 是受到 SW[8] 控制的，即 SW[8] 为 1 时，CPU 时钟暂停，从而使 CPU 工作暂停。

## 显示模块

显示模块主要分两个显示部份，一部分是 LED 灯，另一部分是七段数码管。LED 灯我直接写在了 `topcpu` 下，而七段数码管部份我写在了 `display` 模块下。

LED 灯 LED[15] 显示 CPU 的时钟 CLK，当 SW[9] 为 0 时，LED[14] 表示 `Jump` 控制信号，LED[13] 表示 `PCSrc` 控制信号，而 LED[12:8] 表示 `PCNext[6:2]`，LED[7:0] 表示 `PC[9:2]`；当 SW[9] 为 1 时，LED[14:8] 表示 PC 加 4 对应的 `PCp4[6:0]`，LED[7:0] 表示 PC 分支跳转地址 `PCB[7:0]`。

七段数码管中，最左边两位表示当前 PC 的十六进制值最低两位，紧接着的两位数码管表示 AluOut 对应十六进制值的最低两位，剩下的右边四个数码管显示寄存器或内存中数据对应十六进制的低四位。

对于寄存器和内存的显示，我使用 SW[0] 指定地址对象：当 SW[0] 为 0 时，显示寄存器的值，SW[5:1] 指定寄存器地址；当 SW[0] 为 1 时，显示内存的值，SW[6:1] 指定内存地址。

最后，我还添加了暂停功能，SW[8] 为 1 时，CPU 会暂停工作，而显示模块仍可以正常显示工作。

## 关于 BUG

之前一直是仿真运行正确而上板子好象并不正确，主要问题在于我的 PC 显示出错了，PC 模 4 为 0，所以最后两位不需要显示，而我将最后四位都没有显示，所以会出现 PC 和状态不对应的情况。

## 仿真结果

第一个仿真结果对应的是课本上的 testbench 的代码。
![sim1](1.png)

第二个仿真对应代码为修改 testbench 代码，具体更改见以下代码（注释的表示修改过）
```
	always @(*)
		case (A)
			6'b00_0000: RD <= 32'h20020005;
			6'b00_0001: RD <= 32'h2003000c;
			6'b00_0010: RD <= 32'h3067001c; // andi $7, $3, 28
			6'b00_0011: RD <= 32'h34e40005; // ori $4, $7, 5
			6'b00_0100: RD <= 32'h00642824;
			6'b00_0101: RD <= 32'h00a42820;
			6'b00_0110: RD <= 32'h10a7000a;
			6'b00_0111: RD <= 32'h28640005; // slti $4, $3, 5
			6'b00_1000: RD <= 32'h14800001; // bne $4, $0, around
			6'b00_1001: RD <= 32'h00000000; // nop
			6'b00_1010: RD <= 32'h00e2202a;
			6'b00_1011: RD <= 32'h00853820;
			6'b00_1100: RD <= 32'h00e23822;
			6'b00_1101: RD <= 32'hac670044;
			6'b00_1110: RD <= 32'h8c020050;
			6'b00_1111: RD <= 32'h08000011;
			6'b01_0000: RD <= 32'h20020001;
			6'b01_0001: RD <= 32'hac020054;
			default: RD <= 32'b0;
		endcase
```
仿真结果如下图：
![sim2](2.png)
